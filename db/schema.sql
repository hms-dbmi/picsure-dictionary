CREATE schema dict;

CREATE TABLE dict.dataset (
    DATASET_ID INT GENERATED BY DEFAULT AS IDENTITY,
    REF VARCHAR(512) NOT NULL,
    FULL_NAME VARCHAR(512) NOT NULL,
    ABBREVIATION VARCHAR(512) NOT NULL,
    DESCRIPTION TEXT DEFAULT '',
    PRIMARY KEY (DATASET_ID),
    UNIQUE (REF)
);

CREATE TABLE dict.dataset_meta (
    DATASET_META_ID INT GENERATED BY DEFAULT AS IDENTITY,
    DATASET_ID INT NOT NULL,
    KEY VARCHAR(256) NOT NULL,
    VALUE TEXT NOT NULL,
    UNIQUE (KEY, DATASET_ID),
    CONSTRAINT fk_study FOREIGN KEY(DATASET_ID) REFERENCES dict.dataset(DATASET_ID)
);

CREATE TABLE dict.consent (
    CONSENT_ID INT GENERATED BY DEFAULT AS IDENTITY,
    DATASET_ID INT NOT NULL,
    CONSENT_CODE VARCHAR(512) NOT NULL,
    DESCRIPTION VARCHAR(512) NOT NULL,
    PARTICIPANT_COUNT INT NOT NULL DEFAULT 12,
    VARIABLE_COUNT INT NOT NULL DEFAULT 99,
    SAMPLE_COUNT INT NOT NULL DEFAULT 14,
    AUTHZ VARCHAR(512) NOT NULL,
    PRIMARY KEY (CONSENT_ID),
    UNIQUE (CONSENT_CODE, DATASET_ID)
);

CREATE TABLE dict.concept_node (
    CONCEPT_NODE_ID INT GENERATED BY DEFAULT AS IDENTITY,
    DATASET_ID INT NOT NULL,
    NAME VARCHAR NOT NULL,
    DISPLAY VARCHAR NOT NULL,
    CONCEPT_TYPE VARCHAR(32) NOT NULL DEFAULT 'Interior',
    CONCEPT_PATH VARCHAR(10000) NOT NULL DEFAULT 'INVALID',
    PARENT_ID INT,
    SEARCHABLE_FIELDS TSVECTOR,
    PRIMARY KEY (CONCEPT_NODE_ID),
    CONSTRAINT fk_parent FOREIGN KEY (PARENT_ID) REFERENCES dict.CONCEPT_NODE(CONCEPT_NODE_ID),
    CONSTRAINT fk_study FOREIGN KEY (DATASET_ID) REFERENCES dict.dataset(DATASET_ID)
);
CREATE UNIQUE INDEX concept_node_concept_path_idx ON dict.CONCEPT_NODE (md5(CONCEPT_PATH));

CREATE TABLE dict.concept_node_meta (
    CONCEPT_NODE_META_ID INT GENERATED BY DEFAULT AS IDENTITY,
    CONCEPT_NODE_ID INT NOT NULL,
    KEY VARCHAR(256) NOT NULL,
    VALUE TEXT NOT NULL,
    PRIMARY KEY (CONCEPT_NODE_META_ID),
    UNIQUE (KEY, CONCEPT_NODE_ID),
    CONSTRAINT fk_CONCEPT_NODE FOREIGN KEY (CONCEPT_NODE_ID) REFERENCES dict.CONCEPT_NODE(CONCEPT_NODE_ID)
);
CREATE TABLE dict.facet_category (
    FACET_CATEGORY_ID INT GENERATED BY DEFAULT AS IDENTITY,
    NAME VARCHAR(512) NOT NULL,
    DISPLAY VARCHAR(512) NOT NULL,
    DESCRIPTION TEXT DEFAULT '',
    PRIMARY KEY (FACET_CATEGORY_ID),
    UNIQUE (NAME)
);

CREATE TABLE dict.facet (
    FACET_ID INT GENERATED BY DEFAULT AS IDENTITY,
    FACET_CATEGORY_ID INT NOT NULL,
    NAME VARCHAR(512) NOT NULL,
    DISPLAY VARCHAR(512) NOT NULL,
    DESCRIPTION TEXT DEFAULT '',
    PARENT_ID INT,
    PRIMARY KEY (FACET_ID),
    UNIQUE (NAME, FACET_CATEGORY_ID),
    CONSTRAINT fk_parent FOREIGN KEY (PARENT_ID) REFERENCES dict.facet(FACET_ID),
    CONSTRAINT fk_category FOREIGN KEY (FACET_CATEGORY_ID) REFERENCES dict.facet_category(FACET_CATEGORY_ID)
);

CREATE TABLE dict.facet_meta (
    FACET_META_ID INT GENERATED BY DEFAULT AS IDENTITY,
    FACET_ID INT NOT NULL,
    KEY VARCHAR(256) NOT NULL,
    VALUE TEXT NOT NULL,
    UNIQUE (KEY, FACET_ID),
    CONSTRAINT fk_facet FOREIGN KEY(FACET_ID) REFERENCES dict.facet(FACET_ID)
);

CREATE TABLE dict.facet_category_meta (
    FACET_CATEGORY_META_ID INT GENERATED BY DEFAULT AS IDENTITY,
    FACET_CATEGORY_ID INT NOT NULL,
    KEY VARCHAR(256) NOT NULL,
    VALUE TEXT NOT NULL,
    UNIQUE (KEY, FACET_CATEGORY_ID),
    CONSTRAINT fk_facet_category FOREIGN KEY(FACET_CATEGORY_ID) REFERENCES dict.facet_category(FACET_CATEGORY_ID)
);

CREATE TABLE dict.facet__concept_node (
    FACET__CONCEPT_NODE_ID INT GENERATED BY DEFAULT AS IDENTITY,
    FACET_ID INT NOT NULL,
    CONCEPT_NODE_ID INT NOT NULL,
    PRIMARY KEY (FACET__CONCEPT_NODE_ID),
    UNIQUE (FACET_ID, CONCEPT_NODE_ID),
    CONSTRAINT fk_facet FOREIGN KEY (FACET_ID) REFERENCES dict.facet(FACET_ID),
    CONSTRAINT fk_concept_node FOREIGN KEY (CONCEPT_NODE_ID) REFERENCES dict.concept_node(CONCEPT_NODE_ID)
);

CREATE TABLE IF NOT EXISTS dict.dataset_harmonization
(
    dataset_harmonization_id INT NOT NULL GENERATED BY DEFAULT AS IDENTITY,
    harmonized_dataset_id INT NOT NULL,
    source_dataset_id INT NOT NULL,
    UNIQUE (harmonized_dataset_id, source_dataset_id),
    CONSTRAINT fk_harmonized_dataset_id FOREIGN KEY (harmonized_dataset_id)
        REFERENCES dict.dataset (dataset_id),
    CONSTRAINT fk_source_dataset_id FOREIGN KEY (source_dataset_id)
        REFERENCES dict.dataset (dataset_id)
);

